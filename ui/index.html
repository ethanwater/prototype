<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>app</title>
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <style>
      body {
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .container {
        margin: auto;
	      margin-top: 5%;
	      width: 15%;
	      color: black;
        text-align: center;
      }

      p {
        text-align: center;
        margin: auto;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <input type="text" id="pass"></input>
      <button id="but"></button>
    </div>
    <p id="test">...</p>
    <p id="time">...</p>
  </body>
</html>
<script>
  function strip(s) {
    return s.replace(/\s+/g, '');
  }

  async function search(endpoint, query, aborter) {
    const response = await fetch(`/${endpoint}?q=${query}`, {signal: aborter});
    const text = await response.text();
    if (response.ok) {
      return text;
    } else {
      throw new Error(text);
    }
  }

  function main() {
    const query = document.getElementById('pass');
    const button = document.getElementById('but');
    const loader = document.getElementById('test');
    const timer = document.getElementById('time');
    query.focus();
    button.hidden = true;

    let controller; 
    let pending = 0; 
    const displayed = new Set(); 
    const perform_search = () => {
      if (controller != undefined) {
        controller.abort();
      }
      controller = new AbortController();

      for (const endpoint of ['github_user_query']) {
        if (pending == 0) {
          loader.hidden = false;
        }
        pending++;

        var start_time = performance.now();
        search(endpoint, query.value, controller.signal).then((v) => {
          const results = JSON.parse(v);
          if (results == null || results.length == 0) {
            loader.innerHTML = "red";
          } else {
            loader.innerHTML = v;
          }
        }).finally(() => {
          pending--;
          if (pending == 0) {
            //loader.hidden = true;
          }
        });
        var end_time = performance.now();
        timer.innerHTML = (end_time - start_time);
      }
    }

    button.addEventListener('click', perform_search);

    query.addEventListener('keypress', (e) => {
      if (e.key == 'Enter' && strip(query.value) != "") {
        perform_search();
      }
    });

    query.addEventListener('input', (e) => {
      if (strip(query.value) == "") {
        button.disabled = true;
      } else {
        button.disabled = false;
      }
    });
  }

  document.addEventListener('DOMContentLoaded', main);
</script>